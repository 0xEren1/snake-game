<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Base Mini App Meta -->
<meta property="og:title" content="Snake on Base" />
<meta property="og:description" content="Mint your access pass and play Snake on Base." />
<meta property="og:image" content="https://https://snake-game-nine-alpha-54.vercel.app//favicon.png" />
<meta name="fc:miniapp" content="true" />

<!-- Mini App SDK -->
<script src="https://unpkg.com/@farcaster/miniapp-sdk/dist/index.umd.js"></script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake on Base</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="manifest" href="/manifest.json">
<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:20px;
}
#container{width:360px;position:relative;text-align:center;}
canvas{display:none;background:#111;}
#score{
  position:absolute;
  top:10px;
  right:10px;
  font-size:14px;
  display:none;
}
.overlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,.85);
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  gap:15px;
  padding:20px;
}
button{
  padding:12px 24px;
  border:none;border-radius:8px;
  font-size:16px;cursor:pointer;
  transition:all 0.3s;
}
button:hover{transform:scale(1.05);}
button:disabled{opacity:0.5;cursor:not-allowed;}
#controls{display:none;margin-top:10px;}
.pad{
  display:grid;
  grid-template-columns:60px 60px 60px;
  grid-template-rows:60px 60px 60px;
  gap:6px;
  justify-content:center;
}
.ctrl{background:#1a1a1a;color:#fff;font-size:22px;border-radius:10px;}
.boost{background:#333;font-size:14px;}

/* Main Connect Button */
#connectBtn{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color:#fff;
  padding:16px 40px;
  font-size:18px;
  font-weight:bold;
  border-radius:12px;
  cursor:pointer;
  box-shadow:0 4px 15px rgba(102,126,234,0.4);
}
#connectBtn:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(102,126,234,0.6);
}

/* Wallet Selection */
#walletSelect{display:none;}
.wallet-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-top:20px;
  width:100%;
  max-width:300px;
}
.wallet-btn{
  background:#1a1a1a;
  color:#fff;
  padding:20px;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  font-size:14px;
  border:2px solid transparent;
  transition:all 0.3s;
}
.wallet-btn:hover{
  background:#252525;
  border-color:#667eea;
}
.wallet-icon{font-size:32px;}

/* Mint Screen */
#mintScreen{display:none;}
.mint-box{
  background:#1a1a1a;
  padding:30px;
  border-radius:12px;
  margin:20px 0;
  border:2px solid #333;
}
.mint-box h3{margin:0 0 15px 0;color:#667eea;}
.price{font-size:28px;color:#4CAF50;font-weight:bold;margin:15px 0;}
.mint-detail{font-size:13px;opacity:0.7;margin:8px 0;}
#mintBtn{
  background:#4CAF50;
  color:#fff;
  padding:15px 50px;
  font-size:18px;
  font-weight:bold;
}
#mintBtn:hover{background:#45a049;}

/* Wallet Info */
#walletInfo{
  position:absolute;
  top:10px;
  left:10px;
  font-size:11px;
  background:#1a1a1a;
  padding:8px 12px;
  border-radius:6px;
  display:none;
  border:1px solid #333;
}
.status{color:#4CAF50;margin-bottom:4px;font-weight:bold;}
.address{opacity:0.6;}

.loading{
  display:none;
  margin-top:15px;
  color:#667eea;
  font-size:14px;
}
.loading.show{display:block;}

.back-btn{
  background:#444;
  padding:8px 20px;
  font-size:14px;
  margin-top:10px;
}
</style>
</head>
<body>
<div id="container">
<h2>üêç Snake on Base</h2>

<div id="walletInfo">
  <div class="status">‚úÖ Connected</div>
  <div class="address" id="walletAddress"></div>
</div>

<div id="score">SCORE: 0</div>
<canvas id="game" width="360" height="360"></canvas>

<!-- INITIAL SCREEN -->
<div id="initialScreen" class="overlay">
  <h1 style="font-size:48px;margin:0;">üêç</h1>
  <h3 style="margin:10px 0;">Snake on Base</h3>
  <p style="opacity:0.7;font-size:14px;margin-bottom:20px;">Connect your wallet to play</p>
  <button id="connectBtn" onclick="showWalletSelect()">CONNECT WALLET</button>
</div>

<!-- WALLET SELECTION -->
<div id="walletSelect" class="overlay">
  <h3 style="margin:0 0 10px 0;">Choose Your Wallet</h3>
  <div class="wallet-grid">
    <button class="wallet-btn" onclick="connectWallet('metamask')">
      <span class="wallet-icon">ü¶ä</span>
      <span>MetaMask</span>
    </button>
    <button class="wallet-btn" onclick="connectWallet('okx')">
      <span class="wallet-icon">‚≠ï</span>
      <span>OKX Wallet</span>
    </button>
    <button class="wallet-btn" onclick="connectWallet('coinbase')">
      <span class="wallet-icon">üîµ</span>
      <span>Coinbase</span>
    </button>
    <button class="wallet-btn" onclick="connectWallet('rabby')">
      <span class="wallet-icon">üê∞</span>
      <span>Rabby</span>
    </button>
  </div>
  <div class="loading" id="walletLoading">Connecting...</div>
  <button class="back-btn" onclick="backToInitial()">‚Üê Back</button>
</div>

<!-- MINT SCREEN -->
<div id="mintScreen" class="overlay">
  <div class="mint-box">
    <h3>üé´ Snake Access Pass</h3>
    <p class="mint-detail">You need an Access Pass to play the game</p>
    <div class="price">0.00003 ETH</div>
    <p class="mint-detail">‚ú® One-time mint ‚Ä¢ Play forever</p>
    <p class="mint-detail">üîó Base Network</p>
  </div>
  <button id="mintBtn" onclick="mintNFT()">MINT NOW</button>
  <div class="loading" id="mintLoading">Processing transaction...</div>
  <button class="back-btn" onclick="disconnectWallet()">Disconnect Wallet</button>
</div>

<!-- GAME MENU -->
<div id="menu" class="overlay" style="display:none;">
  <h3 style="margin:0 0 20px 0;">Ready to Play!</h3>
  <button onclick="startGame()" style="background:#4CAF50;padding:15px 50px;font-size:18px;">PLAY</button>
  <button class="back-btn" onclick="disconnectWallet()">Disconnect Wallet</button>
</div>

<!-- GAME OVER -->
<div id="gameOver" class="overlay" style="display:none;">
  <h2 style="margin:0;">GAME OVER</h2>
  <p style="font-size:24px;margin:15px 0;">Score: <span id="finalScore">0</span></p>
  <button onclick="startGame()" style="background:#4CAF50;padding:15px 40px;">PLAY AGAIN</button>
  <button class="back-btn" onclick="backToMenu()">‚Üê Menu</button>
</div>

<!-- CONTROLS -->
<div id="controls">
  <div class="pad">
    <div></div><button class="ctrl" onclick="setDir(0,-1)">‚¨ÜÔ∏è</button><div></div>
    <button class="ctrl" onclick="setDir(-1,0)">‚¨ÖÔ∏è</button>
    <button class="ctrl boost" ontouchstart="boostOn()" ontouchend="boostOff()"></button>
    <button class="ctrl" onclick="setDir(1,0)">‚û°Ô∏è</button>
    <div></div><button class="ctrl" onclick="setDir(0,1)">‚¨áÔ∏è</button><div></div>
  </div>
</div>

<script>
// Contract Details
const CONTRACT_ADDRESS = "0x483BF7B4aE4Ffc5f45Dd72bB04A4939d70777c56";
const MINT_PRICE = "30000000000000"; // 0.00003 ETH in wei
const BASE_CHAIN_ID = "0x2105"; // Base mainnet: 8453

let userAddress = null;
let hasNFT = false;

// Game variables
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const grid=18;
const size=canvas.width/grid;
let snake, food, dx, dy, loopId;
let speed=300;
let score=0;
let spacePressed=false;

// Show wallet selection
function showWalletSelect() {
  hideAllScreens();
  document.getElementById('walletSelect').style.display = 'flex';
}

function backToInitial() {
  hideAllScreens();
  document.getElementById('initialScreen').style.display = 'flex';
}

// Connect Wallet
async function connectWallet(walletType) {
  try {
    document.getElementById('walletLoading').classList.add('show');
    
    // Check if wallet exists
    if (!window.ethereum) {
      alert('‚ùå No Web3 wallet detected!\n\nPlease install:\n‚Ä¢ MetaMask\n‚Ä¢ OKX Wallet\n‚Ä¢ Coinbase Wallet\n‚Ä¢ Rabby Wallet');
      document.getElementById('walletLoading').classList.remove('show');
      return;
    }

    // Request accounts
    const accounts = await window.ethereum.request({ 
      method: 'eth_requestAccounts' 
    });
    
    if (!accounts || accounts.length === 0) {
      throw new Error('No accounts found');
    }

    userAddress = accounts[0];

    // Check network
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    
    if (chainId !== BASE_CHAIN_ID) {
      // Try to switch to Base
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: BASE_CHAIN_ID }],
        });
      } catch (switchError) {
        // Network not added, add it
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: BASE_CHAIN_ID,
              chainName: 'Base',
              nativeCurrency: { 
                name: 'Ethereum', 
                symbol: 'ETH', 
                decimals: 18 
              },
              rpcUrls: ['https://mainnet.base.org'],
              blockExplorerUrls: ['https://basescan.org']
            }]
          });
        } else {
          throw new Error('Please switch to Base network');
        }
      }
    }

    // Save wallet
    localStorage.setItem('connectedWallet', userAddress);
    
    // Show wallet info
    document.getElementById('walletInfo').style.display = 'block';
    document.getElementById('walletAddress').textContent = 
      userAddress.slice(0,6) + '...' + userAddress.slice(-4);

    // Check NFT balance
    await checkNFTBalance();
    
  } catch (error) {
    console.error('Connection error:', error);
    alert('Connection failed: ' + (error.message || 'Unknown error'));
    document.getElementById('walletLoading').classList.remove('show');
  }
}

// Check if user has NFT
async function checkNFTBalance() {
  try {
    // balanceOf function signature
    const data = '0x70a08231' + '000000000000000000000000' + userAddress.slice(2);
    
    const result = await window.ethereum.request({
      method: 'eth_call',
      params: [{
        to: CONTRACT_ADDRESS,
        data: data
      }, 'latest']
    });

    // Convert hex to number
    const balance = parseInt(result, 16);
    
    document.getElementById('walletLoading').classList.remove('show');

    if (balance > 0) {
      // Has NFT - show game menu
      hasNFT = true;
      hideAllScreens();
      document.getElementById('menu').style.display = 'flex';
    } else {
      // No NFT - show mint screen
      hasNFT = false;
      hideAllScreens();
      document.getElementById('mintScreen').style.display = 'flex';
    }
    
  } catch (error) {
    console.error('Balance check error:', error);
    alert('Error checking NFT. Please try again.');
    document.getElementById('walletLoading').classList.remove('show');
  }
}

// Mint NFT
async function mintNFT() {
  try {
    document.getElementById('mintBtn').disabled = true;
    document.getElementById('mintLoading').classList.add('show');

    // mint() function signature
    const data = '0x1249c58b';

    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{
        from: userAddress,
        to: CONTRACT_ADDRESS,
        value: '0x' + parseInt(MINT_PRICE).toString(16),
        data: data
      }]
    });

    alert('üöÄ Transaction sent!\n\nHash: ' + txHash.slice(0,10) + '...\n\nWaiting for confirmation...');

    // Wait for transaction (simplified - just wait 10 seconds)
    await new Promise(resolve => setTimeout(resolve, 10000));

    alert('üéâ Mint successful!\n\nYou can now play Snake on Base!');
    
    hasNFT = true;
    hideAllScreens();
    document.getElementById('menu').style.display = 'flex';
    
  } catch (error) {
    console.error('Mint error:', error);
    if (error.code === 4001) {
      alert('‚ùå Transaction cancelled');
    } else {
      alert('‚ùå Mint failed: ' + (error.message || 'Unknown error'));
    }
  } finally {
    document.getElementById('mintBtn').disabled = false;
    document.getElementById('mintLoading').classList.remove('show');
  }
}

// Disconnect
function disconnectWallet() {
  localStorage.removeItem('connectedWallet');
  userAddress = null;
  hasNFT = false;
  document.getElementById('walletInfo').style.display = 'none';
  hideAllScreens();
  document.getElementById('initialScreen').style.display = 'flex';
}

// Auto-connect on load
window.addEventListener('load', async () => {
  const savedWallet = localStorage.getItem('connectedWallet');
  if (savedWallet && window.ethereum) {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length > 0 && accounts[0].toLowerCase() === savedWallet.toLowerCase()) {
        userAddress = accounts[0];
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('walletAddress').textContent = 
          userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        await checkNFTBalance();
      }
    } catch (error) {
      console.error('Auto-connect failed:', error);
    }
  }
});

// Screen management
function hideAllScreens() {
  ['initialScreen', 'walletSelect', 'mintScreen', 'menu', 'gameOver'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
}

function backToMenu() {
  hideAllScreens();
  document.getElementById('menu').style.display = 'flex';
  canvas.style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('score').style.display = 'none';
}

// Game Functions
function startGame(){
  hideAllScreens();
  canvas.style.display="block";
  document.getElementById("controls").style.display="block";
  document.getElementById("score").style.display="block";

  snake=[{x:9,y:9}];
  dx=1; dy=0;
  score=0;
  updateScore();
  food=spawnFood();

  clearInterval(loopId);
  loopId=setInterval(loop,speed);
}

function loop(){
  const head={x:snake[0].x+dx, y:snake[0].y+dy};

  if(head.x<0||head.y<0||head.x>=grid||head.y>=grid||
     snake.some(s=>s.x===head.x&&s.y===head.y)){
    clearInterval(loopId);
    document.getElementById('finalScore').textContent = score;
    document.getElementById("gameOver").style.display="flex";
    return;
  }

  snake.unshift(head);

  if(head.x===food.x&&head.y===food.y){
    score++;
    updateScore();
    food=spawnFood();
  } else snake.pop();

  draw();
}

function draw(){
  ctx.fillStyle="#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#1a1a1a";
  for(let i=0;i<grid;i++){
    ctx.beginPath();
    ctx.moveTo(i*size,0);
    ctx.lineTo(i*size,canvas.height);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0,i*size);
    ctx.lineTo(canvas.width,i*size);
    ctx.stroke();
  }

  ctx.fillStyle="#fff";
  snake.forEach(s=>ctx.fillRect(s.x*size,s.y*size,size-1,size-1));
  ctx.fillRect(food.x*size,food.y*size,size-1,size-1);
}

function spawnFood(){
  return {x:Math.floor(Math.random()*grid),y:Math.floor(Math.random()*grid)};
}

function setDir(x,y){if(x!==-dx||y!==-dy){dx=x;dy=y;}}
function boostOn(){clearInterval(loopId); loopId=setInterval(loop,120);}
function boostOff(){clearInterval(loopId); loopId=setInterval(loop,speed);}

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp"){
    e.preventDefault();
    setDir(0,-1);
  }
  if(e.key==="ArrowDown"){
    e.preventDefault();
    setDir(0,1);
  }
  if(e.key==="ArrowLeft"){
    e.preventDefault();
    setDir(-1,0);
  }
  if(e.key==="ArrowRight"){
    e.preventDefault();
    setDir(1,0);
  }
  if(e.key===" "){
    e.preventDefault();
    if(!spacePressed){
      spacePressed=true;
      boostOn();
    }
  }
});
document.addEventListener("keyup",e=>{
  if(e.key===" "){
    e.preventDefault();
    spacePressed=false;
    boostOff();
  }
});
function updateScore(){document.getElementById("score").innerText="SCORE: "+score;}

// Wallet events
if (window.ethereum) {
  window.ethereum.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) {
      disconnectWallet();
    } else {
      window.location.reload();
    }
  });

  window.ethereum.on('chainChanged', () => {
    window.location.reload();
  });
}
</script>
</body>
</html>
