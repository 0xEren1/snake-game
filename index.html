<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake on Base</title>
<link rel="icon" type="image/png" href="favicon.png">
<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:0;
}
#app{
  width:100%;
  max-width:420px;
  height:100vh;
  display:flex;
  flex-direction:column;
  position:relative;
  background:#0b0b0b;
}
#container{
  flex:1;
  position:relative;
  overflow-y:auto;
  padding:20px;
  padding-bottom:80px;
}
canvas{display:none;background:#111;width:100%;max-width:360px;margin:0 auto;}
#score{
  position:absolute;
  top:10px;
  right:10px;
  font-size:14px;
  display:none;
  z-index:10;
  background:#1a1a1a;
  padding:8px 12px;
  border-radius:6px;
}
.page{display:none;text-align:center;}
.page.active{display:block;}

/* Header */
#header{
  background:#1a1a1a;
  padding:15px 20px;
  text-align:center;
  border-bottom:1px solid #333;
}
#header h2{margin:0;font-size:18px;}

/* Wallet Connection */
#walletSection{
  background:#1a1a1a;
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #333;
}
#walletBtn{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color:#fff;
  padding:10px 20px;
  border:none;
  border-radius:8px;
  font-size:14px;
  cursor:pointer;
  font-weight:bold;
}
#walletInfo{
  display:none;
  font-size:12px;
}
.status{color:#4CAF50;font-weight:bold;margin-right:10px;}

/* Navigation Tabs */
#tabs{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#1a1a1a;
  display:flex;
  justify-content:space-around;
  border-top:2px solid #333;
  z-index:100;
  max-width:420px;
  margin:0 auto;
}
.tab{
  flex:1;
  padding:15px;
  text-align:center;
  cursor:pointer;
  border:none;
  background:transparent;
  color:#888;
  font-size:12px;
  transition:all 0.3s;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:5px;
}
.tab.active{
  color:#667eea;
  background:#1a1a1a;
}
.tab-icon{font-size:24px;}

/* Home Page */
#homePage{padding:20px 0;}
.hero{
  text-align:center;
  margin-bottom:30px;
}
.hero h1{font-size:48px;margin:0;}
.hero p{opacity:0.7;margin:10px 0;}
#playBtn{
  background:#4CAF50;
  color:#fff;
  padding:15px 60px;
  border:none;
  border-radius:12px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
  box-shadow:0 4px 15px rgba(76,175,80,0.4);
  margin:20px 0;
}
#playBtn:disabled{
  background:#333;
  cursor:not-allowed;
  opacity:0.5;
}
.info-box{
  background:#1a1a1a;
  padding:20px;
  border-radius:12px;
  margin:15px 0;
  border:1px solid #333;
}
.info-box h3{margin:0 0 10px 0;color:#667eea;font-size:16px;}
.info-box p{margin:5px 0;font-size:13px;opacity:0.8;}

/* Game Page */
#gamePage{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:10px;
}
.game-container{
  width:100%;
  max-width:360px;
}
#controls{margin-top:20px;width:100%;}
.pad{
  display:grid;
  grid-template-columns:60px 60px 60px;
  grid-template-rows:60px 60px 60px;
  gap:6px;
  justify-content:center;
}
.ctrl{
  background:#1a1a1a;
  color:#fff;
  font-size:22px;
  border-radius:10px;
  border:none;
  cursor:pointer;
}
.boost{background:#333;}

/* Leaderboard Page */
#leaderboardPage{padding:20px 0;}
.leaderboard-header{
  text-align:center;
  margin-bottom:20px;
}
.leaderboard-header h2{margin:0;font-size:24px;}
.leaderboard-header p{opacity:0.7;font-size:13px;margin:5px 0;}
.leaderboard-list{
  background:#1a1a1a;
  border-radius:12px;
  overflow:hidden;
}
.leaderboard-item{
  padding:15px 20px;
  border-bottom:1px solid #333;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.leaderboard-item:last-child{border-bottom:none;}
.rank{
  font-size:20px;
  font-weight:bold;
  width:40px;
}
.rank.first{color:#FFD700;}
.rank.second{color:#C0C0C0;}
.rank.third{color:#CD7F32;}
.player-info{flex:1;margin:0 15px;}
.player-address{font-size:14px;opacity:0.8;}
.player-score{font-size:18px;font-weight:bold;color:#4CAF50;}
.empty-state{
  text-align:center;
  padding:40px 20px;
  opacity:0.5;
}

/* Wallet Selection Modal */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  z-index:1000;
  align-items:center;
  justify-content:center;
}
.modal.active{display:flex;}
.modal-content{
  background:#1a1a1a;
  padding:30px;
  border-radius:12px;
  max-width:300px;
  width:90%;
}
.modal-content h3{margin:0 0 20px 0;text-align:center;}
.wallet-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.wallet-btn{
  background:#252525;
  padding:20px 10px;
  border-radius:10px;
  border:2px solid transparent;
  cursor:pointer;
  text-align:center;
  transition:all 0.3s;
}
.wallet-btn:hover{
  border-color:#667eea;
  background:#2a2a2a;
}
.wallet-icon{font-size:32px;margin-bottom:8px;}
.wallet-name{font-size:13px;}
.close-modal{
  background:#444;
  padding:10px 20px;
  border-radius:8px;
  border:none;
  color:#fff;
  margin-top:15px;
  width:100%;
  cursor:pointer;
}

/* Mint Modal */
#mintModal .modal-content{max-width:350px;}
.mint-box{
  background:#252525;
  padding:20px;
  border-radius:10px;
  margin:15px 0;
  text-align:center;
}
.mint-box h3{margin:0 0 10px 0;color:#667eea;}
.price{font-size:32px;color:#4CAF50;font-weight:bold;margin:15px 0;}
.mint-detail{font-size:12px;opacity:0.7;margin:5px 0;}
#mintBtn{
  background:#4CAF50;
  color:#fff;
  padding:15px 40px;
  border:none;
  border-radius:10px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  width:100%;
  margin-top:10px;
}
#mintBtn:disabled{background:#333;cursor:not-allowed;}

.loading{
  text-align:center;
  color:#667eea;
  font-size:14px;
  margin-top:10px;
  display:none;
}
.loading.show{display:block;}

/* Game Over */
#gameOver{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:500;
}
#gameOver.active{display:flex;}
.gameover-content{
  background:#1a1a1a;
  padding:40px;
  border-radius:12px;
  text-align:center;
}
.gameover-content h2{margin:0 0 20px 0;font-size:28px;}
.final-score{font-size:36px;color:#4CAF50;margin:20px 0;}
.gameover-btn{
  background:#4CAF50;
  color:#fff;
  padding:12px 30px;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
  margin:5px;
}
.gameover-btn.secondary{background:#444;}
</style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <div id="header">
    <h2>üêç Snake on Base</h2>
  </div>

  <!-- Wallet Connection -->
  <div id="walletSection">
    <div>
      <button id="walletBtn" onclick="openWalletModal()">Connect Wallet</button>
      <div id="walletInfo">
        <span class="status">‚úÖ</span>
        <span id="walletAddress"></span>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div id="container">
    
    <!-- HOME PAGE -->
    <div id="homePage" class="page active">
      <div class="hero">
        <h1>üêç</h1>
        <p>Classic Snake Game on Base Blockchain</p>
        <button id="playBtn" onclick="goToGame()" disabled>
          Connect Wallet to Play
        </button>
      </div>

      <div class="info-box">
        <h3>üé´ How to Play</h3>
        <p>1. Connect your wallet</p>
        <p>2. Mint Snake Access Pass (0.00003 ETH)</p>
        <p>3. Play unlimited games forever!</p>
      </div>

      <div class="info-box">
        <h3>üéÆ Controls</h3>
        <p>üñ±Ô∏è PC: Arrow keys to move, Space to boost</p>
        <p>üì± Mobile: Touch controls + center button to boost</p>
      </div>

      <div class="info-box">
        <h3>üèÜ Your Stats</h3>
        <p>High Score: <strong id="userHighScore">0</strong></p>
        <p>Games Played: <strong id="gamesPlayed">0</strong></p>
      </div>
    </div>

    <!-- GAME PAGE -->
    <div id="gamePage" class="page">
      <div class="game-container">
        <div id="score">SCORE: 0</div>
        <canvas id="game" width="360" height="360"></canvas>
        <div id="controls">
          <div class="pad">
            <div></div><button class="ctrl" onclick="setDir(0,-1)">‚¨ÜÔ∏è</button><div></div>
            <button class="ctrl" onclick="setDir(-1,0)">‚¨ÖÔ∏è</button>
            <button class="ctrl boost" ontouchstart="boostOn()" ontouchend="boostOff()"></button>
            <button class="ctrl" onclick="setDir(1,0)">‚û°Ô∏è</button>
            <div></div><button class="ctrl" onclick="setDir(0,1)">‚¨áÔ∏è</button><div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- LEADERBOARD PAGE -->
    <div id="leaderboardPage" class="page">
      <div class="leaderboard-header">
        <h2>üèÜ Leaderboard</h2>
        <p>Top players this week</p>
      </div>
      <div class="leaderboard-list" id="leaderboardList">
        <div class="empty-state">
          <p>No scores yet. Be the first to play!</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <div id="tabs">
    <button class="tab active" onclick="switchTab('home')">
      <span class="tab-icon">üè†</span>
      <span>Home</span>
    </button>
    <button class="tab" onclick="switchTab('game')">
      <span class="tab-icon">üéÆ</span>
      <span>Play</span>
    </button>
    <button class="tab" onclick="switchTab('leaderboard')">
      <span class="tab-icon">üèÜ</span>
      <span>Leaderboard</span>
    </button>
  </div>
</div>

<!-- Wallet Selection Modal -->
<div id="walletModal" class="modal">
  <div class="modal-content">
    <h3>Choose Your Wallet</h3>
    <div class="wallet-grid">
      <button class="wallet-btn" onclick="connectWallet('metamask')">
        <div class="wallet-icon">ü¶ä</div>
        <div class="wallet-name">MetaMask</div>
      </button>
      <button class="wallet-btn" onclick="connectWallet('okx')">
        <div class="wallet-icon">‚≠ï</div>
        <div class="wallet-name">OKX</div>
      </button>
      <button class="wallet-btn" onclick="connectWallet('coinbase')">
        <div class="wallet-icon">üîµ</div>
        <div class="wallet-name">Coinbase</div>
      </button>
      <button class="wallet-btn" onclick="connectWallet('rabby')">
        <div class="wallet-icon">üê∞</div>
        <div class="wallet-name">Rabby</div>
      </button>
    </div>
    <div class="loading" id="walletLoading">Connecting...</div>
    <button class="close-modal" onclick="closeWalletModal()">Cancel</button>
  </div>
</div>

<!-- Mint Modal -->
<div id="mintModal" class="modal">
  <div class="modal-content">
    <h3>Mint Access Pass</h3>
    <div class="mint-box">
      <h3>üé´ Snake Access Pass</h3>
      <p class="mint-detail">Play unlimited games forever</p>
      <div class="price">0.00003 ETH</div>
      <p class="mint-detail">‚ú® One-time purchase</p>
      <p class="mint-detail">üîó Base Network</p>
    </div>
    <button id="mintBtn" onclick="mintNFT()">MINT NOW</button>
    <div class="loading" id="mintLoading">Processing...</div>
    <button class="close-modal" onclick="closeMintModal()">Cancel</button>
  </div>
</div>

<!-- Game Over -->
<div id="gameOver">
  <div class="gameover-content">
    <h2>GAME OVER</h2>
    <div class="final-score" id="finalScore">0</div>
    <button class="gameover-btn" onclick="restartGame()">PLAY AGAIN</button>
    <button class="gameover-btn secondary" onclick="backToHome()">HOME</button>
  </div>
</div>

<script>
// Contract Details
const CONTRACT_ADDRESS = "0x483BF7B4aE4Ffc5f45Dd72bB04A4939d70777c56";
const MINT_PRICE = "30000000000000";
const BASE_CHAIN_ID = "0x2105";

let userAddress = null;
let hasNFT = false;

// Game variables
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const grid = 18;
const size = canvas.width / grid;
let snake, food, dx, dy, loopId;
let speed = 300;
let score = 0;
let spacePressed = false;
let highScore = parseInt(localStorage.getItem('highScore')) || 0;
let gamesPlayed = parseInt(localStorage.getItem('gamesPlayed')) || 0;

// Update stats display
function updateStatsDisplay() {
  document.getElementById('userHighScore').textContent = highScore;
  document.getElementById('gamesPlayed').textContent = gamesPlayed;
}
updateStatsDisplay();

// Tab Navigation
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  
  event.target.closest('.tab').classList.add('active');
  document.getElementById(tab + 'Page').classList.add('active');
  
  if (tab === 'leaderboard') {
    loadLeaderboard();
  }
}

// Wallet Modal
function openWalletModal() {
  document.getElementById('walletModal').classList.add('active');
}
function closeWalletModal() {
  document.getElementById('walletModal').classList.remove('active');
}
function closeMintModal() {
  document.getElementById('mintModal').classList.remove('active');
}

// Connect Wallet
async function connectWallet(walletType) {
  try {
    document.getElementById('walletLoading').classList.add('show');
    
    if (!window.ethereum) {
      alert('‚ùå Please install a Web3 wallet');
      document.getElementById('walletLoading').classList.remove('show');
      return;
    }

    const accounts = await window.ethereum.request({ 
      method: 'eth_requestAccounts' 
    });
    
    if (!accounts || accounts.length === 0) {
      throw new Error('No accounts found');
    }

    userAddress = accounts[0];

    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    
    if (chainId !== BASE_CHAIN_ID) {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: BASE_CHAIN_ID }],
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: BASE_CHAIN_ID,
              chainName: 'Base',
              nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
              rpcUrls: ['https://mainnet.base.org'],
              blockExplorerUrls: ['https://basescan.org']
            }]
          });
        } else {
          throw new Error('Please switch to Base network');
        }
      }
    }

    localStorage.setItem('connectedWallet', userAddress);
    
    document.getElementById('walletBtn').style.display = 'none';
    document.getElementById('walletInfo').style.display = 'block';
    document.getElementById('walletAddress').textContent = 
      userAddress.slice(0,6) + '...' + userAddress.slice(-4);

    await checkNFTBalance();
    closeWalletModal();
    
  } catch (error) {
    console.error('Connection error:', error);
    alert('Connection failed: ' + (error.message || 'Unknown error'));
    document.getElementById('walletLoading').classList.remove('show');
  }
}

// Check NFT Balance
async function checkNFTBalance() {
  try {
    const data = '0x70a08231' + '000000000000000000000000' + userAddress.slice(2);
    
    const result = await window.ethereum.request({
      method: 'eth_call',
      params: [{
        to: CONTRACT_ADDRESS,
        data: data
      }, 'latest']
    });

    const balance = parseInt(result, 16);
    document.getElementById('walletLoading').classList.remove('show');

    if (balance > 0) {
      hasNFT = true;
      document.getElementById('playBtn').disabled = false;
      document.getElementById('playBtn').textContent = 'PLAY NOW';
    } else {
      hasNFT = false;
      document.getElementById('mintModal').classList.add('active');
    }
    
  } catch (error) {
    console.error('Balance check error:', error);
    alert('Error checking NFT');
    document.getElementById('walletLoading').classList.remove('show');
  }
}

// Mint NFT
async function mintNFT() {
  try {
    document.getElementById('mintBtn').disabled = true;
    document.getElementById('mintLoading').classList.add('show');

    const data = '0x1249c58b';

    const txHash = await window.ethereum.request({
      method: 'eth_sendTransaction',
      params: [{
        from: userAddress,
        to: CONTRACT_ADDRESS,
        value: '0x' + parseInt(MINT_PRICE).toString(16),
        data: data
      }]
    });

    alert('üöÄ Transaction sent! Waiting...');
    await new Promise(resolve => setTimeout(resolve, 10000));
    alert('üéâ Mint successful! You can now play!');
    
    hasNFT = true;
    document.getElementById('playBtn').disabled = false;
    document.getElementById('playBtn').textContent = 'PLAY NOW';
    closeMintModal();
    
  } catch (error) {
    console.error('Mint error:', error);
    if (error.code === 4001) {
      alert('‚ùå Transaction cancelled');
    } else {
      alert('‚ùå Mint failed: ' + (error.message || 'Unknown error'));
    }
  } finally {
    document.getElementById('mintBtn').disabled = false;
    document.getElementById('mintLoading').classList.remove('show');
  }
}

// Go to game
function goToGame() {
  if (!hasNFT) {
    alert('Please mint Snake Access Pass first');
    return;
  }
  switchTab('game');
  setTimeout(() => startGame(), 100);
}

// Game Functions
function startGame() {
  canvas.style.display = "block";
  document.getElementById("score").style.display = "block";

  snake = [{x:9, y:9}];
  dx = 1;
  dy = 0;
  score = 0;
  updateScore();
  food = spawnFood();

  clearInterval(loopId);
  loopId = setInterval(loop, speed);
}

function loop() {
  const head = {x: snake[0].x + dx, y: snake[0].y + dy};

  if (head.x < 0 || head.y < 0 || head.x >= grid || head.y >= grid ||
     snake.some(s => s.x === head.x && s.y === head.y)) {
    clearInterval(loopId);
    endGame();
    return;
  }

  snake.unshift(head);

  if (head.x === food.x && head.y === food.y) {
    score++;
    updateScore();
    food = spawnFood();
  } else snake.pop();

  draw();
}

function draw() {
  ctx.fillStyle = "#111";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = "#1a1a1a";
  for (let i = 0; i < grid; i++) {
    ctx.beginPath();
    ctx.moveTo(i * size, 0);
    ctx.lineTo(i * size, canvas.height);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, i * size);
    ctx.lineTo(canvas.width, i * size);
    ctx.stroke();
  }

  ctx.fillStyle = "#fff";
  snake.forEach(s => ctx.fillRect(s.x * size, s.y * size, size - 1, size - 1));
  ctx.fillRect(food.x * size, food.y * size, size - 1, size - 1);
}

function spawnFood() {
  return {x: Math.floor(Math.random() * grid), y: Math.floor(Math.random() * grid)};
}

function setDir(x, y) {
  if (x !== -dx || y !== -dy) {
    dx = x;
    dy = y;
  }
}

function boostOn() {
  clearInterval(loopId);
  loopId = setInterval(loop, 120);
}

function boostOff() {
  clearInterval(loopId);
  loopId = setInterval(loop, speed);
}

function updateScore() {
  document.getElementById("score").innerText = "SCORE: " + score;
}

function endGame() {
  gamesPlayed++;
  localStorage.setItem('gamesPlayed', gamesPlayed);
  
  if (score > highScore) {
    highScore = score;
    localStorage.setItem('highScore', highScore);
  }
  
  updateStatsDisplay();
  saveScoreToLeaderboard(score);
  
  document.getElementById('finalScore').textContent = score;
  document.getElementById('gameOver').classList.add('active');
}

function restartGame() {
  document.getElementById('gameOver').classList.remove('active');
  startGame();
}

function backToHome() {
  document.getElementById('gameOver').classList.remove('active');
  canvas.style.display = 'none';
  document.getElementById('score').style.display = 'none';
  switchTab('home');
}

// Leaderboard Functions
function saveScoreToLeaderboard(score) {
  let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
  
  leaderboard.push({
    address: userAddress,
    score: score,
    timestamp: Date.now()
  });
  
  leaderboard.sort((a, b) => b.score - a.score);
  leaderboard = leaderboard.slice(0, 50); // Top 50
  
  localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
}

function loadLeaderboard() {
  let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
  const list = document.getElementById('leaderboardList');
  
  if (leaderboard.length === 0) {
    list.innerHTML = '<div class="empty-state"><p>No scores yet. Be the first to play!</p></div>';
    return;
  }
  
  let html = '';
  leaderboard.slice(0, 10).forEach((entry, index) => {
    const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
    html += `
      <div class="leaderboard-item">
        <div class="rank ${rankClass}">#${index + 1}</div>
        <div class="player-info">
          <div class="player-address">${entry.address.slice(0,6)}...${entry.address.slice(-4)}</div>
        </div>
        <div class="player-score">${entry.score}</div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// Keyboard Controls
document.addEventListener("keydown", e => {
  if (e.key === "ArrowUp") {
    e.preventDefault();
    setDir(0, -1);
  }
  if (e.key === "ArrowDown") {
    e.preventDefault();
    setDir(0, 1);
  }
  if (e.key === "ArrowLeft") {
    e.preventDefault();
    setDir(-1, 0);
  }
  if (e.key === "ArrowRight") {
    e.preventDefault();
    setDir(1, 0);
  }
  if (e.key === " ") {
    e.preventDefault();
    if (!spacePressed) {
      spacePressed = true;
      boostOn();
    }
  }
});

document.addEventListener("keyup", e => {
  if (e.key === " ") {
    e.preventDefault();
    spacePressed = false;
    boostOff();
  }
});

// Wallet events
if (window.ethereum) {
  window.ethereum.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) {
      location.reload();
    } else {
      location.reload();
    }
  });

  window.ethereum.on('chainChanged', () => {
    location.reload();
  });
}

// Auto-connect
window.addEventListener('load', async () => {
  const savedWallet = localStorage.getItem('connectedWallet');
  if (savedWallet && window.ethereum) {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length > 0 && accounts[0].toLowerCase() === savedWallet.toLowerCase()) {
        userAddress = accounts[0];
        document.getElementById('walletBtn').style.display = 'none';
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('walletAddress').textContent = 
          userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        await checkNFTBalance();
      }
    } catch (error) {
      console.error('Auto-connect failed:', error);
    }
  }
});
</script>
</body>
</html>
