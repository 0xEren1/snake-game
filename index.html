<script>
const CONTRACT_ADDRESS = "0x483BF7B4aE4Ffc5f45Dd72bB04A4939d70777c56";
const ABI = [
  "function balanceOf(address owner) view returns (uint256)",
  "function mint() payable"
];

let provider, signer, contract;
let dir = "right";
let interval = null;
let gameOver = false;

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let snake, food;

function resetGame() {
  snake = [{ x: 150, y: 150 }];
  food = randomFood();
  dir = "right";
  gameOver = false;
}

function randomFood() {
  return {
    x: Math.floor(Math.random() * 30) * 10,
    y: Math.floor(Math.random() * 30) * 10
  };
}

function draw() {
  ctx.clearRect(0, 0, 300, 300);

  ctx.fillStyle = "white";
  snake.forEach(p => ctx.fillRect(p.x, p.y, 10, 10));

  ctx.fillStyle = "white";
  ctx.fillRect(food.x, food.y, 10, 10);

  if (gameOver) {
    ctx.fillStyle = "red";
    ctx.font = "20px Arial";
    ctx.fillText("GAME OVER", 85, 140);
    ctx.fillText("PLAY", 120, 170);
  }
}

function move() {
  if (gameOver) return;

  let head = { ...snake[0] };
  if (dir === "right") head.x += 10;
  if (dir === "left") head.x -= 10;
  if (dir === "up") head.y -= 10;
  if (dir === "down") head.y += 10;

  if (
    head.x < 0 ||
    head.y < 0 ||
    head.x >= 300 ||
    head.y >= 300
  ) {
    gameOver = true;
    draw();
    return;
  }

  snake.unshift(head);

  if (head.x === food.x && head.y === food.y) {
    food = randomFood();
  } else {
    snake.pop();
  }

  draw();
}

function setDir(d) {
  if (gameOver) return;
  dir = d;
}

canvas.addEventListener("click", () => {
  if (gameOver) {
    resetGame();
  }
});

async function connectWallet() {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  const address = await signer.getAddress();
  const balance = await contract.balanceOf(address);

  document.getElementById("connectBtn").style.display = "none";

  if (balance.gt(0)) {
    startGame();
  } else {
    document.getElementById("mintBtn").style.display = "inline-block";
  }
}

async function mint() {
  await contract.mint({
    value: ethers.utils.parseEther("0.00003")
  });
  startGame();
}

function startGame() {
  document.getElementById("mintBtn").style.display = "none";
  document.getElementById("controls").style.display = "block";
  canvas.style.display = "block";

  resetGame();
  if (interval) clearInterval(interval);
  interval = setInterval(move, 150);
}

document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("mintBtn").onclick = mint;
</script>
