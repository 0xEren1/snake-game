import React, { useState, useEffect, useRef } from 'react';

export default function SnakeGame() {
  const canvasRef = useRef(null);
  const [score, setScore] = useState(0);
  const [gameOver, setGameOver] = useState(false);
  const [gameStarted, setGameStarted] = useState(false);
  
  const gridSize = 20;
  const baseSpeed = 300;
  const boostSpeed = 100;
  
  const gameState = useRef({
    snake: [{ x: 10, y: 10 }],
    food: { x: 15, y: 15 },
    direction: { x: 1, y: 0 },
    nextDirection: { x: 1, y: 0 },
    speed: baseSpeed,
    isBoosting: false
  });

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const cellSize = canvas.width / gridSize;

    const drawGame = () => {
      // Arka plan
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Grid çizgileri
      ctx.strokeStyle = '#16213e';
      ctx.lineWidth = 1;
      for (let i = 0; i <= gridSize; i++) {
        ctx.beginPath();
        ctx.moveTo(i * cellSize, 0);
        ctx.lineTo(i * cellSize, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i * cellSize);
        ctx.lineTo(canvas.width, i * cellSize);
        ctx.stroke();
      }

      // Yılan
      gameState.current.snake.forEach((segment, index) => {
        ctx.fillStyle = index === 0 ? '#00ff41' : '#00cc33';
        ctx.fillRect(
          segment.x * cellSize + 1,
          segment.y * cellSize + 1,
          cellSize - 2,
          cellSize - 2
        );
        
        // Yılan başı gözleri
        if (index === 0) {
          ctx.fillStyle = '#000';
          const eyeSize = cellSize / 6;
          const eyeOffset = cellSize / 4;
          ctx.fillRect(
            segment.x * cellSize + eyeOffset,
            segment.y * cellSize + eyeOffset,
            eyeSize,
            eyeSize
          );
          ctx.fillRect(
            segment.x * cellSize + cellSize - eyeOffset - eyeSize,
            segment.y * cellSize + eyeOffset,
            eyeSize,
            eyeSize
          );
        }
      });

      // Yem
      ctx.fillStyle = '#ff0040';
      ctx.beginPath();
      ctx.arc(
        gameState.current.food.x * cellSize + cellSize / 2,
        gameState.current.food.y * cellSize + cellSize / 2,
        cellSize / 2 - 2,
        0,
        Math.PI * 2
      );
      ctx.fill();
    };

    drawGame();
  }, [gameStarted, score, gameOver]);

  useEffect(() => {
    if (!gameStarted || gameOver) return;

    const gameLoop = setInterval(() => {
      const state = gameState.current;
      
      // Yönü güncelle
      state.direction = state.nextDirection;

      // Yeni baş pozisyonu
      const newHead = {
        x: state.snake[0].x + state.direction.x,
        y: state.snake[0].y + state.direction.y
      };

      // Duvar kontrolü
      if (newHead.x < 0 || newHead.x >= gridSize || 
          newHead.y < 0 || newHead.y >= gridSize) {
        setGameOver(true);
        return;
      }

      // Kendine çarpma kontrolü
      if (state.snake.some(segment => 
        segment.x === newHead.x && segment.y === newHead.y
      )) {
        setGameOver(true);
        return;
      }

      // Yılanı hareket ettir
      state.snake.unshift(newHead);

      // Yem yeme kontrolü
      if (newHead.x === state.food.x && newHead.y === state.food.y) {
        setScore(prev => prev + 10);
        // Yeni yem oluştur
        let newFood;
        do {
          newFood = {
            x: Math.floor(Math.random() * gridSize),
            y: Math.floor(Math.random() * gridSize)
          };
        } while (state.snake.some(segment => 
          segment.x === newFood.x && segment.y === newFood.y
        ));
        state.food = newFood;
      } else {
        state.snake.pop();
      }

      // Çizimi tetikle
      setScore(prev => prev);
    }, state.speed);

    return () => clearInterval(gameLoop);
  }, [gameStarted, gameOver]);

  const changeDirection = (newDir) => {
    const state = gameState.current;
    // Ters yöne gitmeyi engelle
    if (state.direction.x + newDir.x === 0 && 
        state.direction.y + newDir.y === 0) {
      return;
    }
    state.nextDirection = newDir;
  };

  const startBoost = () => {
    gameState.current.speed = boostSpeed;
    gameState.current.isBoosting = true;
  };

  const stopBoost = () => {
    gameState.current.speed = baseSpeed;
    gameState.current.isBoosting = false;
  };

  const startGame = () => {
    gameState.current = {
      snake: [{ x: 10, y: 10 }],
      food: { x: 15, y: 15 },
      direction: { x: 1, y: 0 },
      nextDirection: { x: 1, y: 0 },
      speed: baseSpeed,
      isBoosting: false
    };
    setScore(0);
    setGameOver(false);
    setGameStarted(true);
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-gray-900 to-gray-800 p-4">
      {/* Skor Tablosu */}
      <div className="absolute top-4 right-4 bg-gray-800 border-2 border-green-500 rounded-lg p-4 shadow-lg">
        <div className="text-green-400 text-sm font-semibold mb-1">SKOR</div>
        <div className="text-white text-3xl font-bold">{score}</div>
      </div>

      {/* Oyun Alanı */}
      <div className="relative">
        <canvas
          ref={canvasRef}
          width={400}
          height={400}
          className="border-4 border-green-500 rounded-lg shadow-2xl"
        />
        
        {/* Başlangıç/Game Over Ekranı */}
        {(!gameStarted || gameOver) && (
          <div className="absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center rounded-lg">
            <div className="text-center">
              {gameOver && (
                <>
                  <div className="text-red-500 text-4xl font-bold mb-4">GAME OVER</div>
                  <div className="text-white text-2xl mb-6">Skor: {score}</div>
                </>
              )}
              {!gameStarted && !gameOver && (
                <div className="text-green-400 text-4xl font-bold mb-6">YILAN OYUNU</div>
              )}
              <button
                onClick={startGame}
                className="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-xl transition-colors"
              >
                {gameOver ? 'Tekrar Oyna' : 'Başla'}
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Kontrol Tuşları */}
      <div className="mt-8 relative">
        <div className="grid grid-cols-3 gap-2">
          {/* Üst sıra */}
          <div></div>
          <button
            onClick={() => changeDirection({ x: 0, y: -1 })}
            className="w-16 h-16 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg border-2 border-gray-500 transition-colors"
          >
            ▲
          </button>
          <div></div>
          
          {/* Orta sıra */}
          <button
            onClick={() => changeDirection({ x: -1, y: 0 })}
            className="w-16 h-16 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg border-2 border-gray-500 transition-colors"
          >
            ◄
          </button>
          <button
            onMouseDown={startBoost}
            onMouseUp={stopBoost}
            onMouseLeave={stopBoost}
            onTouchStart={startBoost}
            onTouchEnd={stopBoost}
            className="w-16 h-16 bg-yellow-600 hover:bg-yellow-500 active:bg-yellow-700 text-white font-bold rounded-lg shadow-lg border-2 border-yellow-500 transition-colors"
          >
            ⚡
          </button>
          <button
            onClick={() => changeDirection({ x: 1, y: 0 })}
            className="w-16 h-16 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg border-2 border-gray-500 transition-colors"
          >
            ►
          </button>
          
          {/* Alt sıra */}
          <div></div>
          <button
            onClick={() => changeDirection({ x: 0, y: 1 })}
            className="w-16 h-16 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg shadow-lg border-2 border-gray-500 transition-colors"
          >
            ▼
          </button>
          <div></div>
        </div>
      </div>

      {/* Açıklama */}
      <div className="mt-6 text-gray-400 text-center">
        <div className="text-sm">Normal Hız: 300ms | Hızlı Hız: 100ms</div>
        <div className="text-xs mt-2">⚡ tuşuna basılı tutarak hızlan!</div>
      </div>
    </div>
  );
}
