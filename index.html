<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake on Base</title>
<script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:20px;
}
#container{width:360px;position:relative;text-align:center;}
canvas{display:none;background:#111;}
#score{
  position:absolute;
  top:10px;
  right:10px;
  font-size:14px;
  display:none;
}
.overlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,.85);
  display:flex;flex-direction:column;
  justify-content:center;align-items:center;
  gap:15px;
}
button{
  padding:12px 24px;
  border:none;border-radius:8px;
  font-size:16px;cursor:pointer;
  transition:all 0.3s;
}
button:hover{transform:scale(1.05);}
button:disabled{opacity:0.5;cursor:not-allowed;}
#controls{display:none;margin-top:10px;}
.pad{
  display:grid;
  grid-template-columns:60px 60px 60px;
  grid-template-rows:60px 60px 60px;
  gap:6px;
  justify-content:center;
}
.ctrl{background:#1a1a1a;color:#fff;font-size:22px;border-radius:10px;}
.boost{background:#333;font-size:14px;}

/* Wallet Connect Screen */
#walletConnect{display:flex;}
.wallet-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:20px;
}
.wallet-btn{
  background:#1a1a1a;
  color:#fff;
  padding:15px;
  border-radius:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  font-size:14px;
}
.wallet-btn:hover{background:#252525;}

/* Mint Screen */
#mintScreen{display:none;}
.mint-info{
  background:#1a1a1a;
  padding:20px;
  border-radius:10px;
  margin:20px 0;
}
.mint-info p{margin:10px 0;font-size:14px;}
.price{font-size:24px;color:#4CAF50;font-weight:bold;}
#mintBtn{background:#4CAF50;color:#fff;}
#mintBtn:hover{background:#45a049;}

/* Connected Wallet Info */
#walletInfo{
  position:absolute;
  top:10px;
  left:10px;
  font-size:12px;
  background:#1a1a1a;
  padding:8px 12px;
  border-radius:6px;
  display:none;
}
.status{color:#4CAF50;margin-bottom:5px;}
.address{opacity:0.7;}

#loadingMsg{display:none;margin-top:10px;font-size:14px;color:#4CAF50;}
</style>
</head>
<body>
<div id="container">
<h2>üêç Snake on Base</h2>

<div id="walletInfo">
  <div class="status">‚úÖ Connected</div>
  <div class="address" id="walletAddress"></div>
</div>

<div id="score">SCORE: 0</div>
<canvas id="game" width="360" height="360"></canvas>

<!-- WALLET CONNECT -->
<div id="walletConnect" class="overlay">
  <h3>Connect Your Wallet</h3>
  <p style="font-size:14px;opacity:0.8;">Choose your wallet to continue</p>
  <div class="wallet-grid">
    <button class="wallet-btn" onclick="connectWallet('metamask')">
      ü¶ä<br>MetaMask
    </button>
    <button class="wallet-btn" onclick="connectWallet('okx')">
      ‚≠ï<br>OKX Wallet
    </button>
    <button class="wallet-btn" onclick="connectWallet('coinbase')">
      üîµ<br>Coinbase
    </button>
    <button class="wallet-btn" onclick="connectWallet('rabby')">
      üê∞<br>Rabby
    </button>
  </div>
  <div id="loadingMsg">Connecting...</div>
</div>

<!-- MINT SCREEN -->
<div id="mintScreen" class="overlay">
  <h3>Mint Snake Access Pass</h3>
  <div class="mint-info">
    <p>üé´ You need a Snake Access Pass to play</p>
    <p class="price">0.00003 ETH</p>
    <p style="font-size:12px;opacity:0.7;">One-time purchase ‚Ä¢ Play forever</p>
  </div>
  <button id="mintBtn" onclick="mintNFT()">MINT NOW</button>
  <button onclick="disconnectWallet()" style="background:#666;">Disconnect</button>
  <div id="loadingMsg">Processing...</div>
</div>

<!-- MENU -->
<div id="menu" class="overlay" style="display:none;">
  <button onclick="startGame()">PLAY</button>
  <button onclick="disconnectWallet()" style="background:#666;">Disconnect</button>
</div>

<!-- GAME OVER -->
<div id="gameOver" class="overlay" style="display:none;">
  <h2>GAME OVER</h2>
  <p style="font-size:20px;margin:10px 0;">Score: <span id="finalScore">0</span></p>
  <button onclick="startGame()">PLAY AGAIN</button>
  <button onclick="backToMenu()" style="background:#666;">MENU</button>
</div>

<!-- CONTROLS -->
<div id="controls">
  <div class="pad">
    <div></div><button class="ctrl" onclick="setDir(0,-1)">‚¨ÜÔ∏è</button><div></div>
    <button class="ctrl" onclick="setDir(-1,0)">‚¨ÖÔ∏è</button>
    <button class="ctrl boost" onmousedown="boostOn()" onmouseup="boostOff()">BOOST</button>
    <button class="ctrl" onclick="setDir(1,0)">‚û°Ô∏è</button>
    <div></div><button class="ctrl" onclick="setDir(0,1)">‚¨áÔ∏è</button><div></div>
  </div>
</div>

<script>
// Contract Details
const CONTRACT_ADDRESS = "0x483BF7B4aE4Ffc5f45Dd72bB04A4939d70777c56";
const MINT_PRICE = "0.00003";
const BASE_CHAIN_ID = "0x2105"; // Base mainnet: 8453 (0x2105)

// Minimal ABI for NFT contract
const CONTRACT_ABI = [
  "function mint() public payable",
  "function balanceOf(address owner) public view returns (uint256)"
];

let provider;
let signer;
let contract;
let userAddress;

// Game variables
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const grid=18;
const size=canvas.width/grid;
let snake, food, dx, dy, loopId;
let speed=300;
let score=0;
let spacePressed=false;

// Connect Wallet
async function connectWallet(walletType) {
  try {
    showLoading(true);
    
    if (typeof window.ethereum === 'undefined') {
      alert('Please install a Web3 wallet (MetaMask, OKX, etc.)');
      showLoading(false);
      return;
    }

    // Request account access
    const accounts = await window.ethereum.request({ 
      method: 'eth_requestAccounts' 
    });
    
    userAddress = accounts[0];

    // Check if on Base network
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    
    if (chainId !== BASE_CHAIN_ID) {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: BASE_CHAIN_ID }],
        });
      } catch (switchError) {
        // Chain not added, add it
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: BASE_CHAIN_ID,
              chainName: 'Base',
              nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
              rpcUrls: ['https://mainnet.base.org'],
              blockExplorerUrls: ['https://basescan.org']
            }]
          });
        } else {
          throw switchError;
        }
      }
    }

    // Setup ethers
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

    // Save to localStorage
    localStorage.setItem('connectedWallet', userAddress);

    // Check if user has NFT
    await checkNFTBalance();
    
  } catch (error) {
    console.error('Connection error:', error);
    alert('Failed to connect wallet: ' + error.message);
    showLoading(false);
  }
}

// Check NFT Balance
async function checkNFTBalance() {
  try {
    const balance = await contract.balanceOf(userAddress);
    
    document.getElementById('walletInfo').style.display = 'block';
    document.getElementById('walletAddress').textContent = 
      userAddress.slice(0,6) + '...' + userAddress.slice(-4);

    if (balance.gt(0)) {
      // User has NFT - show game menu
      showScreen('menu');
    } else {
      // User needs to mint
      showScreen('mintScreen');
    }
    
    showLoading(false);
  } catch (error) {
    console.error('Balance check error:', error);
    alert('Error checking NFT balance');
    showLoading(false);
  }
}

// Mint NFT
async function mintNFT() {
  try {
    showLoading(true);
    document.getElementById('mintBtn').disabled = true;

    const tx = await contract.mint({
      value: ethers.utils.parseEther(MINT_PRICE)
    });

    alert('Transaction sent! Waiting for confirmation...');
    await tx.wait();

    alert('üéâ Mint successful! You can now play!');
    
    // Show game menu
    showScreen('menu');
    
  } catch (error) {
    console.error('Mint error:', error);
    if (error.code === 4001) {
      alert('Transaction cancelled');
    } else {
      alert('Mint failed: ' + error.message);
    }
    document.getElementById('mintBtn').disabled = false;
  } finally {
    showLoading(false);
  }
}

// Disconnect Wallet
function disconnectWallet() {
  localStorage.removeItem('connectedWallet');
  userAddress = null;
  provider = null;
  signer = null;
  contract = null;
  document.getElementById('walletInfo').style.display = 'none';
  showScreen('walletConnect');
}

// Auto-connect on page load
window.addEventListener('load', async () => {
  const savedWallet = localStorage.getItem('connectedWallet');
  if (savedWallet && typeof window.ethereum !== 'undefined') {
    try {
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length > 0 && accounts[0].toLowerCase() === savedWallet.toLowerCase()) {
        await connectWallet('auto');
      }
    } catch (error) {
      console.error('Auto-connect failed:', error);
    }
  }
});

// Screen Management
function showScreen(screenId) {
  ['walletConnect', 'mintScreen', 'menu', 'gameOver'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById(screenId).style.display = 'flex';
}

function showLoading(show) {
  const msgs = document.querySelectorAll('#loadingMsg');
  msgs.forEach(msg => msg.style.display = show ? 'block' : 'none');
}

function backToMenu() {
  showScreen('menu');
  canvas.style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('score').style.display = 'none';
}

// Game Functions
function startGame(){
  showScreen('dummy'); // Hide all overlays
  canvas.style.display="block";
  document.getElementById("controls").style.display="block";
  document.getElementById("score").style.display="block";

  snake=[{x:9,y:9}];
  dx=1; dy=0;
  score=0;
  updateScore();
  food=spawnFood();

  clearInterval(loopId);
  loopId=setInterval(loop,speed);
}

function loop(){
  const head={x:snake[0].x+dx, y:snake[0].y+dy};

  if(head.x<0||head.y<0||head.x>=grid||head.y>=grid||
     snake.some(s=>s.x===head.x&&s.y===head.y)){
    clearInterval(loopId);
    document.getElementById('finalScore').textContent = score;
    document.getElementById("gameOver").style.display="flex";
    return;
  }

  snake.unshift(head);

  if(head.x===food.x&&head.y===food.y){
    score++;
    updateScore();
    food=spawnFood();
  } else snake.pop();

  draw();
}

function draw(){
  ctx.fillStyle="#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.strokeStyle="#1a1a1a";
  for(let i=0;i<grid;i++){
    ctx.beginPath();
    ctx.moveTo(i*size,0);
    ctx.lineTo(i*size,canvas.height);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0,i*size);
    ctx.lineTo(canvas.width,i*size);
    ctx.stroke();
  }

  ctx.fillStyle="#fff";
  snake.forEach(s=>ctx.fillRect(s.x*size,s.y*size,size-1,size-1));
  ctx.fillRect(food.x*size,food.y*size,size-1,size-1);
}

function spawnFood(){
  return {x:Math.floor(Math.random()*grid),y:Math.floor(Math.random()*grid)};
}

function setDir(x,y){if(x!==-dx||y!==-dy){dx=x;dy=y;}}
function boostOn(){clearInterval(loopId); loopId=setInterval(loop,120);}
function boostOff(){clearInterval(loopId); loopId=setInterval(loop,speed);}

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowUp") setDir(0,-1);
  if(e.key==="ArrowDown") setDir(0,1);
  if(e.key==="ArrowLeft") setDir(-1,0);
  if(e.key==="ArrowRight") setDir(1,0);
  if(e.key===" "){
    e.preventDefault();
    if(!spacePressed){
      spacePressed=true;
      boostOn();
    }
  }
});
document.addEventListener("keyup",e=>{
  if(e.key===" "){
    e.preventDefault();
    spacePressed=false;
    boostOff();
  }
});
function updateScore(){document.getElementById("score").innerText="SCORE: "+score;}

// Listen for account changes
if (typeof window.ethereum !== 'undefined') {
  window.ethereum.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) {
      disconnectWallet();
    } else if (userAddress && accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
      window.location.reload();
    }
  });

  window.ethereum.on('chainChanged', () => {
    window.location.reload();
  });
}
</script>
</body>
</html>
